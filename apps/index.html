<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RGZTEC • Command Center</title>
  <meta name="description" content="RGZTEC Command Center — Seller & Admin operations."/>
  <meta name="theme-color" content="#0b0f17"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f17;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --ink:#e9eefc;
      --muted:rgba(233,238,252,.70);
      --muted2:rgba(233,238,252,.55);
      --good:#00ffa3;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --brand:#ff6b00;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r12:12px; --r14:14px; --r16:16px; --r18:18px; --r22:22px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% -20%, rgba(255,107,0,.18), transparent 60%),
        radial-gradient(900px 540px at 110% 10%, rgba(0,255,163,.12), transparent 55%),
        radial-gradient(1000px 600px at 30% 120%, rgba(140,90,255,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    a{color:inherit; text-decoration:none}
    button{font-family:inherit}

    /* App shell */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "sidebar topbar"
        "sidebar main";
    }

    /* Topbar */
    .topbar{
      grid-area: topbar;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      backdrop-filter: blur(10px);
      position:relative;
      z-index:10;
    }

    .top-left{display:flex; align-items:center; gap:12px; min-width: 320px}
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .logo-dot{
      width:12px; height:12px; border-radius:999px;
      background: conic-gradient(from 180deg, var(--good), var(--brand), #7c3aed, var(--good));
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .env-badge{
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--muted);
    }

    .top-search{
      flex:1;
      max-width: 720px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }
    .top-search svg{opacity:.9}
    .top-search input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--ink);
      font-size:14px;
    }
    .top-search input::placeholder{color: rgba(233,238,252,.45)}

    .top-right{
      display:flex; align-items:center; justify-content:flex-end;
      gap:10px; min-width: 320px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--ink)}
    .btn{
      height:38px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      cursor:pointer;
      font-weight:800;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      border-color: rgba(0,255,163,.30);
      background: linear-gradient(180deg, rgba(0,255,163,.18), rgba(0,255,163,.10));
      box-shadow: 0 12px 30px rgba(0,255,163,.08);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.35);
      background: linear-gradient(180deg, rgba(255,107,107,.14), rgba(255,107,107,.08));
    }

    /* Sidebar */
    .sidebar{
      grid-area: sidebar;
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      position:relative;
      z-index:11;
    }

    .side-card{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r18);
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
    }

    .side-title{
      font-size:12px;
      color: var(--muted2);
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:900;
      margin-bottom:10px;
    }

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .nav a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: var(--r14);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight:800;
      transition: all .15s ease;
    }
    .nav a:hover{
      color:var(--ink);
      border-color: rgba(255,107,0,.35);
      box-shadow: 0 14px 30px rgba(255,107,0,.08);
      transform: translateY(-1px);
    }
    .nav a.active{
      color: #0b0f17;
      background: linear-gradient(180deg, rgba(0,255,163,.95), rgba(0,255,163,.70));
      border-color: rgba(0,255,163,.35);
    }
    .nav .right{
      font-family: var(--mono);
      font-size:11px;
      opacity:.85;
    }

    .mini-kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      padding:12px;
      border-radius: var(--r16);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .kpi .k{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      margin-bottom:6px;
    }
    .kpi .v{
      font-size:18px;
      font-weight:900;
      letter-spacing:-.02em;
      color: var(--ink);
    }

    .footer-note{
      margin-top:auto;
      color: var(--muted2);
      font-size:12px;
      line-height:1.5;
    }
    .footer-note code{font-family:var(--mono); font-size:11px; color:var(--muted)}
    .hr{height:1px; background:rgba(255,255,255,.10); margin:10px 0}

    /* Main content */
    .main{
      grid-area: main;
      overflow:auto;
      padding:18px 18px 28px;
      min-height:0;
    }
    .content{
      max-width: 1220px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* Cards / page */
    .page{
      border-radius: var(--r22);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .page-head{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
    }
    .page-title{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:-.02em;
    }
    .page-sub{
      margin:6px 0 0;
      color: var(--muted);
      font-size:13px;
      line-height:1.6;
      max-width: 760px;
    }
    .page-body{
      padding:16px 18px 18px;
    }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:9999;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.45);
      color: var(--ink);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      display:none;
      max-width: min(520px, calc(100vw - 32px));
    }
    .toast small{display:block; color:var(--muted); margin-top:4px}

    /* Mobile */
    @media (max-width: 1060px){
      body{overflow:auto}
      .app{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas:
          "topbar"
          "sidebar"
          "main";
      }
      .sidebar{border-right:0; border-bottom:1px solid var(--line)}
      .top-left, .top-right{min-width: auto}
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="side-card">
        <div class="side-title">Navigation</div>
        <nav class="nav" id="nav">
          <a href="/apps/seller" data-route="seller"><span>Seller Hub</span><span class="right">/apps/seller</span></a>
          <a href="/apps/admin"  data-route="admin"><span>Admin</span><span class="right">/apps/admin</span></a>
          <a href="/apps/lab"    data-route="lab"><span>LAB / Sandbox</span><span class="right">/apps/lab</span></a>
          <a href="/apps/search" data-route="search"><span>Search</span><span class="right">/apps/search</span></a>
          <div class="hr"></div>
          <a href="/apps/signin" data-route="signin"><span>Sign In</span><span class="right">/apps/signin</span></a>
          <a href="/apps/open-store" data-route="open-store"><span>Open Store</span><span class="right">/apps/open-store</span></a>
        </nav>
      </div>

      <div class="side-card">
        <div class="side-title">System</div>
        <div class="mini-kpis">
          <div class="kpi">
            <div class="k">Engine</div>
            <div class="v" id="kpiEngine">Booting…</div>
          </div>
          <div class="kpi">
            <div class="k">Session</div>
            <div class="v" id="kpiSession">—</div>
          </div>
        </div>
      </div>

      <div class="footer-note">
        <div><b>RGZTEC Premium Shell</b></div>
        <div>All apps routed from <code>/apps/index.html</code></div>
        <div style="margin-top:6px">Mode: <code id="dbgMode">—</code></div>
      </div>
    </aside>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="top-left">
        <div class="brand">
          <span class="logo-dot" aria-hidden="true"></span>
          <span>RGZTEC</span>
        </div>
        <span class="env-badge" id="envBadge">Command Center</span>
      </div>

      <div class="top-search" role="search" aria-label="Global search">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input id="globalSearch" type="search" placeholder="Search stores, products, sellers… (enter)" />
      </div>

      <div class="top-right">
        <span class="pill" id="whoami"><b>guest</b><span>• no session</span></span>
        <button class="btn primary" id="btnGoLive" type="button" title="Open marketplace home">Home</button>
        <button class="btn danger" id="btnLogout" type="button" title="Sign out">Logout</button>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <div class="content">
        <section class="page" id="page">
          <div class="page-head">
            <div>
              <h1 class="page-title" id="pageTitle">Loading…</h1>
              <p class="page-sub" id="pageSub">Preparing RGZTEC engine and modules.</p>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="pill"><span>Route</span><b id="routeBadge">—</b></span>
              <span class="pill"><span>Status</span><b id="statusBadge">—</b></span>
            </div>
          </div>
          <div class="page-body" id="appRoot">
            <!-- Module renders here -->
          </div>
        </section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast" role="status"></div>

  <script type="module">
    // ============================================================
    // RGZTEC Premium Apps Shell (Single index for /apps/*)
    // ============================================================

    // ---- DOM refs ----
    const $ = (s, r=document) => r.querySelector(s);
    const nav = $("#nav");
    const appRoot = $("#appRoot");
    const pageTitle = $("#pageTitle");
    const pageSub = $("#pageSub");
    const routeBadge = $("#routeBadge");
    const statusBadge = $("#statusBadge");
    const envBadge = $("#envBadge");
    const dbgMode = $("#dbgMode");
    const whoami = $("#whoami");
    const kpiEngine = $("#kpiEngine");
    const kpiSession = $("#kpiSession");
    const toast = $("#toast");

    // ---- Simple toast ----
    function notify(msg, sub=""){
      toast.style.display = "block";
      toast.innerHTML = `<b>${escapeHtml(msg)}</b>${sub ? `<small>${escapeHtml(sub)}</small>` : ""}`;
      clearTimeout(notify._t);
      notify._t = setTimeout(()=> toast.style.display = "none", 2200);
    }

    // ---- Route parsing ----
    function parseRoute(){
      const p = (location.pathname || "/apps").replace(/\/+$/, "");
      // p examples: "/apps", "/apps/admin", "/apps/seller", "/apps/lab"
      const parts = p.split("/").filter(Boolean); // ["apps","admin"]
      const mode = (parts[1] || "seller").toLowerCase();

      // Support: /apps/seller/acme-store -> params after mode
      const params = parts.slice(2);

      // Also support querystring
      const qs = new URLSearchParams(location.search);

      return { mode, params, qs };
    }

    // ---- Session & roles (MVP but premium structure) ----
    function getSession(){
      try { return JSON.parse(localStorage.getItem("rgztec_session") || "null"); }
      catch { return null; }
    }
    function setSession(s){
      localStorage.setItem("rgztec_session", JSON.stringify(s));
    }
    function clearSession(){
      localStorage.removeItem("rgztec_session");
      // seller demo tokens (older)
      localStorage.removeItem("rgz_seller_token");
      localStorage.removeItem("rgz_seller_id");
    }

    // session schema (recommended):
    // { email, role: "seller"|"admin", sellerId?, t }
    function ensureSession(){
      const s = getSession();
      return s && s.email ? s : null;
    }

    function requireAuth(mode){
      // Routes that can be visited without auth:
      const publicRoutes = new Set(["signin", "open-store"]);
      if (publicRoutes.has(mode)) return true;

      const s = ensureSession();
      if (!s){
        location.replace("/apps/signin?next=" + encodeURIComponent(location.pathname + location.search));
        return false;
      }

      // Admin guard:
      if (mode === "admin" && s.role !== "admin"){
        location.replace("/apps/seller");
        return false;
      }

      return true;
    }

    // ---- UI: highlight active nav ----
    function setActiveNav(mode){
      nav.querySelectorAll("a[data-route]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("data-route") === mode);
      });
    }

    function setHeaderStatus(mode, status){
      routeBadge.textContent = mode;
      statusBadge.textContent = status;
      dbgMode.textContent = mode;
      envBadge.textContent = mode === "admin" ? "Admin Command Center"
                      : mode === "seller" ? "Seller Hub"
                      : mode === "lab" ? "LAB / Sandbox"
                      : mode === "search" ? "Global Search"
                      : mode === "signin" ? "Sign In"
                      : mode === "open-store" ? "Open Store"
                      : "Command Center";
    }

    function renderError(title, detail){
      pageTitle.textContent = title;
      pageSub.textContent = "A critical module error occurred.";
      appRoot.innerHTML = `
        <div style="padding:18px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)">
          <div style="font-weight:900;margin-bottom:8px">Error</div>
          <div style="color:rgba(233,238,252,.85);line-height:1.6">${escapeHtml(detail || "Unknown error")}</div>
          <pre style="margin-top:12px;white-space:pre-wrap;color:rgba(233,238,252,.65);font-family:var(--mono);font-size:12px">${escapeHtml(String(detail||""))}</pre>
        </div>
      `;
    }

    // ---- HTML escape ----
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ============================================================
    // 1) BOOT ENGINE
    // ============================================================
    setHeaderStatus("boot", "booting");
    kpiEngine.textContent = "Boot…";

    let Engine;
    try{
      Engine = (await import("/apps/core/engine.js")).default;
      await Engine.boot();
      kpiEngine.textContent = "OK";
      notify("Engine booted", "Core is ready.");
    }catch(e){
      kpiEngine.textContent = "FAIL";
      renderError("Engine failed to boot", (e && e.message) ? e.message : String(e));
      throw e;
    }

    // ============================================================
    // 2) TOPBAR ACTIONS
    // ============================================================
    $("#btnGoLive").addEventListener("click", () => {
      // Marketplace home (docs)
      location.href = "/";
    });

    $("#btnLogout").addEventListener("click", () => {
      clearSession();
      notify("Signed out", "Session cleared.");
      setTimeout(()=> location.replace("/apps/signin"), 250);
    });

    $("#globalSearch").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const q = String(e.target.value || "").trim();
      if (!q) return;
      location.href = "/apps/search?q=" + encodeURIComponent(q);
    });

    // ============================================================
    // 3) ROUTER
    // ============================================================
    async function loadModule(mode){
      // Map mode -> module file
      const map = {
        seller: "/apps/modules/seller-hub.js",
        admin:  "/apps/modules/admin.js",
        lab:    "/apps/modules/lab.js",
        search: "/apps/modules/search.js",
        signin: "/apps/modules/signin.js",
        "open-store": "/apps/modules/open-store.js"
      };
      const path = map[mode] || map["seller"];
      return (await import(path)).default;
    }

    async function route(){
      const { mode, params, qs } = parseRoute();

      // auth guard
      if (!requireAuth(mode)) return;

      // session ui
      const s = ensureSession();
      const label = s ? `${s.role || "seller"} • ${s.email}` : "guest • no session";
      whoami.innerHTML = s ? `<b>${escapeHtml(s.role || "seller")}</b><span>• ${escapeHtml(s.email)}</span>`
                           : `<b>guest</b><span>• no session</span>`;
      kpiSession.textContent = s ? (s.role === "admin" ? "Admin" : "Active") : "—";

      setActiveNav(mode);
      setHeaderStatus(mode, "loading");

      // page titles
      pageTitle.textContent =
        mode === "admin" ? "Admin Command Center" :
        mode === "seller" ? "Seller Hub" :
        mode === "lab" ? "LAB / Sandbox" :
        mode === "search" ? "Global Search" :
        mode === "signin" ? "Sign In" :
        mode === "open-store" ? "Open Store Application" :
        "Seller Hub";

      pageSub.textContent =
        mode === "admin" ? "Global infrastructure visibility, inventory scanning, and governance." :
        mode === "seller" ? "Manage products, banners, and your storefront with premium tooling." :
        mode === "lab" ? "Experiment safely. This does not affect production data unless you save." :
        mode === "search" ? "Deep scan across stores and sections." :
        mode === "signin" ? "Authenticate to access seller/admin tools." :
        mode === "open-store" ? "Apply to launch a store on RGZTEC." :
        "Premium operations center.";

      // load module
      try{
        const Module = await loadModule(mode);
        setHeaderStatus(mode, "render");

        // clear root
        appRoot.innerHTML = "";

        // standard context
        const ctx = {
          mode,
          params,
          qs,
          Engine,
          session: s,
          navigate: (to) => location.href = to,
          notify
        };

        // Module interface:
        // Module.render(rootEl, ctx)
        await Module.render(appRoot, ctx);

        setHeaderStatus(mode, "ready");
      }catch(e){
        setHeaderStatus(mode, "error");
        renderError("Module load failed", (e && e.message) ? e.message : String(e));
      }
    }

    // handle browser back/forward
    window.addEventListener("popstate", route);

    // initial route
    await route();
  </script>
</body>
</html>


